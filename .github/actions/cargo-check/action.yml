name: 'Cargo check'
description: 'Checks cargo with check, deny, format, clippy, udeps and audit.'

inputs:
  github_token:
    description: 'GitHub token for cargo audit.'
    required: true
  run_cargo_audit:
    description: 'Whether to run cargo audit.'
    required: false
    default: 'false'

runs:
  using: composite
  steps:

    - name: Install rustc nightly
      uses: ./.github/actions/setup-rust
      with:
        toolchain: nightly

    - name: Cargo deny
      uses: EmbarkStudios/cargo-deny-action@3fd3802e88374d3fe9159b834c7714ec57d6c979 # v2
      with:
        command-arguments: "--allow unmaintained --hide-inclusion-graph"

    - name: Cargo check
      shell: ${{ runner.os == 'Windows' && 'msys2 {0}' || 'bash' }}
      run: cargo check --verbose

    - name: Cargo format
      shell: ${{ runner.os == 'Windows' && 'msys2 {0}' || 'bash' }}
      run: cargo fmt --all -- --check --verbose

    - name: Cargo clippy
      shell: ${{ runner.os == 'Windows' && 'msys2 {0}' || 'bash' }}
      run: cargo clippy

    - name: Cargo udeps
      shell: ${{ runner.os == 'Windows' && 'msys2 {0}' || 'bash' }}
      run: |
        cargo install cargo-udeps --locked
        cargo +nightly udeps --all-targets

    - name: Cargo audit
      if: ${{ inputs.run_cargo_audit == 'true' }}
      uses: rustsec/audit-check@dd51754d4e59da7395a4cd9b593f0ff2d61a9b95 # v1.4.1
      with:
        token: ${{ inputs.github_token }}
