name: Foundry Projects

on:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.mdx"
      - "LICENSE"

permissions:
  contents: read
  pull-requests: write

# Cancel the workflow if any new changes pushed to a feature branch or the trunk
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash -ex {0}

jobs:
  constants:
    uses: ./.github/workflows/ci-constants.yaml

  test:
    needs: constants
    runs-on: solx-linux-amd64
    container:
      image: ${{ needs.constants.outputs.llvm_runner_image }}
    strategy:
      fail-fast: false
    env:
      CARGO_TARGET_DIR: ${{ github.workspace }}/.cargo-target
    steps:
      - name: Checkout source
        uses: actions/checkout@v5
        with:
          repository: 'NomicFoundation/solx'
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 1
          submodules: recursive

      - name: Detect main baseline requirement
        id: main-required
        run: |
          source .github/scripts/ci-helpers.sh
          needs_main=$(check_main_required "solx-dev/foundry-tests.toml")
          echo "needs_main=${needs_main}" >> "${GITHUB_OUTPUT}"

      - name: Checkout source (main)
        if: steps.main-required.outputs.needs_main == 'true'
        uses: actions/checkout@v5
        with:
          repository: 'NomicFoundation/solx'
          ref: 'main'
          fetch-depth: 1
          submodules: recursive
          path: 'temp-solx-main'

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-cargo-cache-${{ runner.os }}-${{ runner.arch }}"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Compare LLVM submodule SHAs
        if: steps.main-required.outputs.needs_main == 'true'
        id: llvm-sha
        run: |
          source .github/scripts/ci-helpers.sh
          compare_llvm_shas "." "temp-solx-main" >> "${GITHUB_OUTPUT}"

      - name: Build LLVM (main)
        if: steps.main-required.outputs.needs_main == 'true'
        uses: ./.github/actions/build-llvm
        with:
          build-type: Release
          enable-cache: 'true'
          working-dir: 'temp-solx-main'
          enable-assertions: 'false'
          # TODO: enable MLIR once submodules are switched (also enable-rtti: true)
          # llvm-projects: 'mlir lld'
          llvm-projects: ''

      # Build the main branch
      - name: Building solc (main)
        if: steps.main-required.outputs.needs_main == 'true'
        uses: ./.github/actions/build-solc
        with:
          cmake-build-type: 'Release'
          working-dir: 'temp-solx-main/solx-solidity'
          upload-testing-binary: 'false'
          enable-cache: 'true'

      - name: Build solx (main)
        if: steps.main-required.outputs.needs_main == 'true'
        working-directory: 'temp-solx-main'
        env:
          BOOST_PREFIX: ${{ github.workspace }}/temp-solx-main/solx-solidity/boost/lib
          SOLC_PREFIX: ${{ github.workspace }}/temp-solx-main/solx-solidity/build
        run: cargo build --release --bin solx

      - name: Expose solx (main) at expected path
        if: steps.main-required.outputs.needs_main == 'true'
        run: |
          source .github/scripts/ci-helpers.sh
          ensure_solx_binary "${CARGO_TARGET_DIR:-${GITHUB_WORKSPACE}/target}/release/solx" \
            "${GITHUB_WORKSPACE}/temp-solx-main/target/release"

      - name: Build LLVM (PR)
        uses: ./.github/actions/build-llvm
        with:
          build-type: Release
          enable-cache: 'true'
          enable-assertions: 'false'
          # TODO: enable MLIR once submodules are switched (also enable-rtti: true)
          # llvm-projects: 'mlir lld'
          llvm-projects: ''

      # Build the PR branch
      - name: Building solc
        uses: ./.github/actions/build-solc
        with:
          cmake-build-type: 'Release'
          working-dir: 'solx-solidity'
          upload-testing-binary: 'false'
          enable-cache: 'true'

      - name: Build solx
        env:
          BOOST_PREFIX: ${{ github.workspace }}/solx-solidity/boost/lib
          SOLC_PREFIX: ${{ github.workspace }}/solx-solidity/build
        run: cargo build --release --bin solx

      - name: Expose solx (PR) at expected path
        run: |
          source .github/scripts/ci-helpers.sh
          ensure_solx_binary "${CARGO_TARGET_DIR:-${GITHUB_WORKSPACE}/target}/release/solx" \
            "${GITHUB_WORKSPACE}/target/release"

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.constants.outputs.node_version }}

      - name: Install Yarn
        run: npm install -g yarn

      - name: Build solx-dev
        run: cargo build --release --bin solx-dev

      # Some projects might use hardcoded ssh URLs: force git to use https instead.
      - name: Git https settings
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."https://".insteadOf git://

      - name: Run tests
        id: tests
        run: |
          TARGET_DIR="${CARGO_TARGET_DIR:-./target}"
          "${TARGET_DIR}/release/solx-dev" test foundry

      - name: Upload Excel report
        id: excel-report
        uses: actions/upload-artifact@v4
        with:
          name: foundry-report
          path: ./temp-foundry-reports/foundry-report.xlsx

      - name: Post PR comment
        uses: mshick/add-pr-comment@v2
        with:
          message-id: 'foundry-report'
          message: |
            üìä **Foundry Projects Report**

            ‚û°Ô∏è [**Download**](${{ steps.excel-report.outputs.artifact-url }})
