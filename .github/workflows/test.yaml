name: Tests

# Execute workflow for each PR and with each merge to the trunk
on:
  pull_request:
    # `labeled` allows slang tests to run when the ci:slang label is added
    types: [opened, synchronize, reopened, labeled]
  push:
    branches:
      - main

permissions:
  contents: read

# Cancel the workflow if any new changes pushed to a feature branch or the trunk
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:

  # Detect whether code (non-doc) files changed
  changes:
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: read
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          predicate-quantifier: 'every'
          filters: |
            code:
              - '**'
              - '!docs/**'
              - '!**/*.md'
              - '!**/*.mdx'
              - '!**/LICENSE*'

  # Check for cargo issues
  cargo-checks:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/matter-labs/zksync-llvm-runner@sha256:adcadcafaa4e6604837f6608b7b5628ae429c05f0ddf56ab4e809477721f39e4
    steps:

      - name: Checkout source
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          submodules: true

      # This step is required to checkout submodules
      # that are disabled in .gitmodules config
      - name: Checkout submodules
        run: |
          git config --global --add safe.directory '*'
          git submodule update --force --depth=1 --recursive --checkout

      - name: Build LLVM
        uses: ./.github/actions/build-llvm
        with:
          build-type: RelWithDebInfo
          enable-assertions: 'true'
          enable-mlir: 'true'

      - name: Cargo checks
        uses: ./.github/actions/cargo-check

  # Build and run regression tests
  build-and-test:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    permissions:
      contents: read
      checks: write
    strategy:
      fail-fast: false # finalize testing of all targets even if one failed
      matrix:
        include:
          - name: "MacOS x86"
            runner: macos-15-intel
          - name: "MacOS arm64"
            runner: macos-15
          - name: "Linux x86 gnu"
            runner: ubuntu-24.04
            image: ghcr.io/matter-labs/zksync-llvm-runner@sha256:adcadcafaa4e6604837f6608b7b5628ae429c05f0ddf56ab4e809477721f39e4
            target: "x86_64-unknown-linux-gnu"
          - name: "Linux ARM64 gnu"
            runner: ubuntu-24.04-arm
            image: ghcr.io/matter-labs/zksync-llvm-runner@sha256:adcadcafaa4e6604837f6608b7b5628ae429c05f0ddf56ab4e809477721f39e4
            target: "aarch64-unknown-linux-gnu"
          - name: "Windows"
            runner: windows-2025
            target: "x86_64-pc-windows-gnu"
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.image || '' }} # Special workaround to allow matrix builds with optional container
    name: ${{ matrix.name }}
    steps:

      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          submodules: true

      # This step is required to checkout submodules
      # that are disabled in .gitmodules config
      - name: Checkout submodules
        run: |
          git config --global --add safe.directory '*'
          git submodule update --force --depth=1 --recursive --checkout

      - name: Prepare Windows env
        if: runner.os == 'Windows'
        uses: ./.github/actions/prepare-msys

      - name: Build LLVM
        uses: ./.github/actions/build-llvm
        with:
          build-type: RelWithDebInfo
          enable-assertions: 'true'
          enable-mlir: 'true'

      - name: Building solc
        uses: ./.github/actions/build-solc
        with:
          cmake-build-type: RelWithDebInfo
          working-dir: 'solx-solidity'

      - name: Free disk space (remove LLVM source and build artifacts)
        shell: bash
        run: |
          echo "Before cleanup:" && df -h .
          rm -rf solx-llvm target-llvm/build-final
          echo "After cleanup:" && df -h .

      - name: Run tests
        uses: ./.github/actions/rust-unit-tests
        env:
          BOOST_PREFIX: ${{ github.workspace }}/solx-solidity/boost/lib
          SOLC_PREFIX: ${{ github.workspace }}/solx-solidity/build
        with:
          target: ${{ matrix.target || '' }}

      - name: Free disk space (remove default build artifacts before slang tests)
        if: contains(github.event.pull_request.labels.*.name, 'ci:slang')
        shell: bash
        run: |
          echo "Before cleanup:" && df -h .
          rm -rf target solx-solidity/build solx-solidity/boost
          echo "After cleanup:" && df -h .

      # bindgen's embedded clang needs to know it's targeting MinGW,
      # otherwise it can't parse MinGW-specific __attribute__ extensions
      # in stdlib.h (rust-lang/rust-bindgen#1760).
      - name: Set bindgen target for MinGW
        if: runner.os == 'Windows' && contains(github.event.pull_request.labels.*.name, 'ci:slang')
        shell: bash
        run: echo "BINDGEN_EXTRA_CLANG_ARGS=--target=x86_64-w64-windows-gnu" >> "${GITHUB_ENV}"

      - name: Run slang tests
        if: contains(github.event.pull_request.labels.*.name, 'ci:slang')
        uses: ./.github/actions/rust-unit-tests
        env:
          CARGO_TARGET_DIR: target-slang
        with:
          target: ${{ matrix.target || '' }}
          cargo-test-command: 'test-slang'
          results-xml: 'slang-unit-tests-results.xml'
          check-name: 'Slang Unit Tests Results'

  # Run tests with address sanitizer (label-gated)
  sanitizer:
    if: contains(github.event.pull_request.labels.*.name, 'ci:sanitizer') && !github.event.pull_request.head.repo.fork
    permissions:
      contents: read
      checks: write
    runs-on: solx-linux-amd64
    container:
      image: ghcr.io/matter-labs/zksync-llvm-runner@sha256:adcadcafaa4e6604837f6608b7b5628ae429c05f0ddf56ab4e809477721f39e4
      options: -m 110g
    env:
      TARGET: x86_64-unknown-linux-gnu
      RUST_SANITIZER: 'address'
      LLVM_SANITIZER: 'Address'
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          submodules: true

      - name: Checkout submodules
        run: |
          git config --global --add safe.directory '*'
          git submodule update --force --depth=1 --recursive --checkout

      - name: Build LLVM
        uses: ./.github/actions/build-llvm
        with:
          build-type: RelWithDebInfo
          sanitizer: ${{ env.LLVM_SANITIZER }}
          enable-assertions: 'true'

      - name: Building solc
        uses: ./.github/actions/build-solc
        with:
          cmake-build-type: RelWithDebInfo
          working-dir: 'solx-solidity'

      - name: Run tests
        uses: ./.github/actions/rust-unit-tests
        env:
          BOOST_PREFIX: ${{ github.workspace }}/solx-solidity/boost/lib
          SOLC_PREFIX: ${{ github.workspace }}/solx-solidity/build
        with:
          target: ${{ env.TARGET }}
          sanitizer: ${{ env.RUST_SANITIZER }}

  # Special job that allows some of the jobs to be skipped or failed
  # requiring others to be successful
  pr-checks:
    runs-on: ubuntu-24.04
    if: always()
    needs:
      - changes
      - cargo-checks
      - build-and-test
      - sanitizer
    steps:
      - name: Decide on PR checks
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # release/v1
        with:
          jobs: ${{ toJSON(needs) }}
          allowed-skips: >-
            ${{ needs.changes.outputs.code == 'true' && 'sanitizer' || 'sanitizer, cargo-checks, build-and-test' }}
