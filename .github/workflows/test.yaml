name: Tests

# Execute workflow for each PR and with each merge to the trunk
on:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.mdx"
      - "LICENSE"
  push:
    branches:
      - main
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.mdx"
      - "LICENSE"

permissions:
  contents: read
  pull-requests: write
  checks: write

# Cancel the workflow if any new changes pushed to a feature branch or the trunk
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:

  # Check for cargo issues
  cargo-checks:
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/matter-labs/zksync-llvm-runner@sha256:adcadcafaa4e6604837f6608b7b5628ae429c05f0ddf56ab4e809477721f39e4
    steps:

      - name: Checkout source
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          submodules: true

      # This step is required to checkout submodules
      # that are disabled in .gitmodules config
      - name: Checkout submodules
        run: |
          git config --global --add safe.directory '*'
          git submodule update --force --depth=1 --recursive --checkout

      - name: Build LLVM
        uses: ./.github/actions/build-llvm
        with:
          build-type: RelWithDebInfo
          enable-assertions: 'true'

      - name: Cargo checks
        uses: ./.github/actions/cargo-check
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # Build and run regression tests
  build-and-test:
    strategy:
      fail-fast: false # finalize testing of all targets even if one failed
      matrix:
        include:
          - name: "MacOS x86"
            runner: macos-15-intel
          - name: "MacOS arm64"
            runner: macos-15
          - name: "Linux x86 gnu"
            runner: ubuntu-24.04
            image: ghcr.io/matter-labs/zksync-llvm-runner@sha256:adcadcafaa4e6604837f6608b7b5628ae429c05f0ddf56ab4e809477721f39e4
            target: "x86_64-unknown-linux-gnu"
          - name: "Linux ARM64 gnu"
            runner: ubuntu-24.04-arm
            image: ghcr.io/matter-labs/zksync-llvm-runner@sha256:adcadcafaa4e6604837f6608b7b5628ae429c05f0ddf56ab4e809477721f39e4
            target: "aarch64-unknown-linux-gnu"
          - name: "Windows"
            runner: windows-2025
            target: "x86_64-pc-windows-gnu"
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.image || '' }} # Special workaround to allow matrix builds with optional container
    name: ${{ matrix.name }}
    steps:

      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          submodules: true

      # This step is required to checkout submodules
      # that are disabled in .gitmodules config
      - name: Checkout submodules
        run: |
          git config --global --add safe.directory '*'
          git submodule update --force --depth=1 --recursive --checkout

      - name: Prepare Windows env
        if: runner.os == 'Windows'
        uses: ./.github/actions/prepare-msys

      - name: Build LLVM
        uses: ./.github/actions/build-llvm
        with:
          build-type: RelWithDebInfo
          enable-assertions: 'true'

      - name: Building solc
        uses: ./.github/actions/build-solc
        with:
          cmake-build-type: RelWithDebInfo
          working-dir: 'solx-solidity'

      - name: Free disk space (remove LLVM build artifacts)
        shell: bash
        run: |
          echo "Before cleanup:" && df -h .
          rm -rf target-llvm/build-final
          echo "After cleanup:" && df -h .

      - name: Run tests
        uses: ./.github/actions/rust-unit-tests
        env:
          BOOST_PREFIX: ${{ github.workspace }}/solx-solidity/boost/lib
          SOLC_PREFIX: ${{ github.workspace }}/solx-solidity/build
        with:
          target: ${{ matrix.target || '' }}

  # Run tests with address sanitizer (label-gated)
  sanitizer:
    if: contains(github.event.pull_request.labels.*.name, 'ci:sanitizer') && !github.event.pull_request.head.repo.fork
    runs-on: solx-linux-amd64
    container:
      image: ghcr.io/matter-labs/zksync-llvm-runner@sha256:adcadcafaa4e6604837f6608b7b5628ae429c05f0ddf56ab4e809477721f39e4
      options: -m 110g
    env:
      TARGET: x86_64-unknown-linux-gnu
      RUST_SANITIZER: 'address'
      LLVM_SANITIZER: 'Address'
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          submodules: true

      - name: Checkout submodules
        run: |
          git config --global --add safe.directory '*'
          git submodule update --force --depth=1 --recursive --checkout

      - name: Build LLVM
        uses: ./.github/actions/build-llvm
        with:
          build-type: RelWithDebInfo
          sanitizer: ${{ env.LLVM_SANITIZER }}
          enable-assertions: 'true'

      - name: Building solc
        uses: ./.github/actions/build-solc
        with:
          cmake-build-type: RelWithDebInfo
          working-dir: 'solx-solidity'

      - name: Run tests
        uses: ./.github/actions/rust-unit-tests
        env:
          BOOST_PREFIX: ${{ github.workspace }}/solx-solidity/boost/lib
          SOLC_PREFIX: ${{ github.workspace }}/solx-solidity/build
        with:
          target: ${{ env.TARGET }}
          sanitizer: ${{ env.RUST_SANITIZER }}

  # Special job that allows some of the jobs to be skipped or failed
  # requiring others to be successful
  pr-checks:
    runs-on: ubuntu-24.04
    if: always()
    needs:
      - cargo-checks
      - build-and-test
      - sanitizer
    steps:
      - name: Decide on PR checks
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # release/v1
        with:
          jobs: ${{ toJSON(needs) }}
          allowed-skips: sanitizer
