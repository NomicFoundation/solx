name: Foundry tests and benchmarks

on:
  workflow_call:
    inputs:
      solx_candidate_branch:
        description: 'Specific `solx` candidate ref to use for building `solx`.'
        type: string
        required: false
        default: ''
      solx_reference_branch:
        description: 'Specific `solx` reference ref to use for building `solx`.'
        type: string
        required: false
        default: ''
      compiler_llvm_candidate_branch:
        description: 'Specific LLVM candidate ref to use for building `solx`.'
        type: string
        required: false
        default: ''
      compiler_llvm_reference_branch:
        description: 'Specific LLVM reference ref to use for building `solx`.'
        type: string
        required: false
        default: 'main'
  pull_request:

permissions:
  contents: read
  pull-requests: write

# Cancel the workflow if any new changes pushed to a feature branch or the trunk
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash -ex {0}

jobs:

  build-solx:
    runs-on: solx-linux-amd64
    container:
      image: ghcr.io/matter-labs/zksync-llvm-runner:latest
    strategy:
      fail-fast: false
      matrix:
        type: ["reference", "candidate"]
    steps:

      - name: Checkout source
        uses: actions/checkout@v5
        with:
          repository: 'NomicFoundation/solx'
          submodules: true
          ref: ${{ matrix.type == 'candidate' && inputs.solx_candidate_branch || inputs.solx_reference_branch || '' }}

      # This step is required to checkout submodules
      # that are disabled in .gitmodules config
      - name: Checkout submodules
        run: |
          git config --global --add safe.directory '*'
          git submodule update --init --force --depth=1 --recursive --checkout

      - name: Remove llvm submodule
        if: ${{ contains(github.repository, 'era-compiler-llvm') }}
        run: rm -rf llvm

      - name: Checkout llvm
        if: ${{ contains(github.repository, 'era-compiler-llvm') }}
        uses: actions/checkout@v4
        with:
          repository: 'matter-labs/era-compiler-llvm'
          path: llvm
          ref: ${{ matrix.type == 'candidate' && inputs.compiler_llvm_candidate_branch || inputs.compiler_llvm_reference_branch }}

      - name: Building solc
        uses: ./.github/actions/build-solc
        with:
          cmake-build-type: 'Release'
          working-dir: 'solx-solidity'
          upload-testing-binary: false

      - name: Build LLVM
        uses: ./.github/actions/build-llvm
        with:
          build-type: Release
          enable-assertions: 'false'
          ccache-key: ${{ format('llvm-{0}-{1}', runner.os, runner.arch) }}

      - name: Build solx
        uses: ./.github/actions/build-rust
        env:
          BOOST_PREFIX: ${{ github.workspace }}/solx-solidity/boost/lib
          SOLC_PREFIX: ${{ github.workspace }}/solx-solidity/build
        with:
          exec_name: 'solx'
          target: 'x86_64-unknown-linux-gnu'
          release-suffix: test-${{ matrix.type }}

  test:
    needs: [build-solx]
    runs-on: solx-linux-amd64
    steps:

      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: NomicFoundation/solx
          ref: ${{ inputs.solx_candidate_branch || 'main' }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release*
          merge-multiple: true
          path: .

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install yq
        env:
          YQ_DOWNLOAD_URL: https://github.com/mikefarah/yq/releases/download/v4.45.4/yq_linux_amd64
        run: |
          wget "${YQ_DOWNLOAD_URL}"
          mv yq_linux_amd64 yq
          chmod +x yq

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Yarn
        run: npm install -g yarn

      # Some projects might use hardcoded ssh urls
      # force git to use https instead
      - name: Git https settings
        run: |
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."https://".insteadOf git://

      - name: Build solx-dev
        run: cargo build --release --bin solx-dev

      - name: Run tests
        id: tests
        run: |
          ./target/release/solx-dev test foundry

      - name: Upload jsons
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: 'temp-foundry-reports/'


  excel-reports:
    runs-on: solx-linux-amd64
    container:
      image: ghcr.io/matter-labs/zksync-llvm-runner:latest
    needs: test
    steps:

      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          pattern: 'reports'
          path: 'reports'
          merge-multiple: 'false'

      - name: Upload Excel reports
        id: excel-reports
        uses: actions/upload-artifact@v4
        with:
          name: excel-reports
          path: foundry-benchmark-report.xlsx

      - name: Add PR comment with excel reports link
        uses: mshick/add-pr-comment@v2
        with:
          message-id: 'excel-reports'
          message: |
            ðŸ“Š [**Download Excel Report**](${{ steps.excel-reports.outputs.artifact-url }})
