name: solx Tester

on:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - "**/*.mdx"
      - "LICENSE"

concurrency:
  group: ${{ github.repository_id }}-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: "bash -ex {0}"

permissions:
  contents: read
  pull-requests: write

jobs:

  tests:
    name: tests (${{ matrix.mlir && 'MLIR' || 'non-MLIR' }})
    runs-on: solx-linux-amd64
    container:
      image: ghcr.io/matter-labs/zksync-llvm-runner:latest
      options: -m 110g
    strategy:
      fail-fast: false
      matrix:
        # TODO: enable MLIR once submodules are switched (also enable-rtti: true)
        # mlir: [false, true]
        mlir: [false]
    env:
      BOOST_PREFIX: ${{ github.workspace }}/solx-solidity/boost/lib
      SOLC_PREFIX: ${{ github.workspace }}/solx-solidity/build
    steps:

      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Checkout submodules
        run: |
          git config --global --add safe.directory '*'
          git submodule update --init --force --recursive --depth 1 --checkout

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-cargo-cache-${{ runner.os }}-${{ runner.arch }}"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Build LLVM
        uses: ./.github/actions/build-llvm
        with:
          build-type: 'RelWithDebInfo'
          ccache-key: "llvm-Linux-X64-gnu-${{ matrix.mlir && 'mlir' || 'no-mlir' }}"
          enable-assertions: false
          llvm-projects: ${{ matrix.mlir && 'mlir lld' || '' }}

      - name: Building solc
        uses: ./.github/actions/build-solc
        with:
          cmake-build-type: RelWithDebInfo
          working-dir: 'solx-solidity'
          upload-testing-binary: false
          enable-mlir: ${{ matrix.mlir }}

      - name: Build tester
        run: cargo build --release --bin solx-tester

      - name: Build solx
        uses: ./.github/actions/build-rust
        with:
          exec_name: 'solx'
          build-type: 'release'
          target: 'x86_64-unknown-linux-gnu'

      - name: Run tests
        run: ./target/release/solx-tester --solidity-compiler $(which solx)


  benchmarks:
    runs-on: solx-linux-amd64
    container:
      image: ghcr.io/matter-labs/zksync-llvm-runner:latest
    strategy:
      fail-fast: false
      matrix:
        type: [ "reference", "candidate" ]
    env:
      BOOST_PREFIX: ${{ github.workspace }}/solx-solidity/boost/lib
      SOLC_PREFIX: ${{ github.workspace }}/solx-solidity/build
    steps:

      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: true
          ref: ${{ matrix.type == 'reference' && github.event.pull_request.base.sha || '' }}

      - name: Checkout submodules
        run: |
          git config --global --add safe.directory '*'
          git submodule update --init --force --recursive --depth 1 --checkout

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-cargo-cache-${{ runner.os }}-${{ runner.arch }}"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Build LLVM
        uses: ./.github/actions/build-llvm
        with:
          build-type: 'Release'
          ccache-key: 'llvm-Linux-X64-gnu'
          enable-assertions: false
          # TODO: enable MLIR once submodules are switched (also enable-rtti: true)
          # llvm-projects: 'mlir lld'
          llvm-projects: ''

      - name: Building solc
        uses: ./.github/actions/build-solc
        with:
          cmake-build-type: Release
          working-dir: 'solx-solidity'
          upload-testing-binary: false
          build-type: ${{ matrix.type }}
          # TODO: enable MLIR once submodules are switched (also enable-rtti: true)
          # enable-mlir: true

      - name: Build tester
        run: cargo build --release --bin solx-tester

      - name: Build solx
        run: cargo build --release --bin solx

      - name: Run benchmarks
        run: |
          ./target/release/solx-tester \
            --solidity-compiler ./target/release/solx \
            --mode 'Y M^B3' \
            --benchmark=${{ matrix.type }}-benchmark.json || true

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.type }}-benchmark
          path: ${{ matrix.type }}-benchmark.json


  comparison:
    runs-on: solx-linux-amd64
    container:
      image: ghcr.io/matter-labs/zksync-llvm-runner:latest
    needs: benchmarks
    if: ${{ (failure() || success()) }}
    steps:

      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - uses: actions/download-artifact@v4
        with:
          pattern: '*-benchmark'
          merge-multiple: true

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-cargo-cache-${{ runner.os }}-${{ runner.arch }}"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Build converter
        run: cargo build --release --bin solx-benchmark-converter

      - name: Run benchmark converter
        run: |
          cat reference-benchmark.json \
            | jq '{data: ., project: "solx-tester", toolchain: "00.solx-main"}' > reference.json
          cat candidate-benchmark.json \
            | jq '{data: ., project: "solx-tester", toolchain: "01.solx"}' > candidate.json
          ./target/release/solx-benchmark-converter \
            --output-path solx-tester-report.xlsx reference.json candidate.json

      - name: Upload Excel reports
        id: excel-report
        uses: actions/upload-artifact@v4
        with:
          name: solx-tester-report
          path: solx-tester-report.xlsx

      - name: Add PR comment with excel reports link
        uses: mshick/add-pr-comment@v2
        with:
          message-id: 'solx-tester-report'
          message: |
            ğŸ“Š **solx Tester Report**

            â¡ï¸ [**Download**](${{ steps.excel-report.outputs.artifact-url }})
